---
layout: layouts/base.njk
---
{# Syntax highlighter CSS #}
<style>{% include "node_modules/prismjs/themes/prism-okaidia.css" %}</style>
<style>{% include "css/prism-diff.css" %}</style>

{# Reading progress bar #}
<div class="reading-progress" id="reading-progress"></div>

<article class="post-content">
  <h1>{{ title }}</h1>
  
  <ul class="post-metadata">
    <li><time datetime="{{ page.date | htmlDateString }}">{{ page.date | readableDate }}</time></li>
    {%- for tag in tags | filterTagList %}
    {%- set tagUrl %}/tags/{{ tag | slugify }}/{% endset %}
    <li><a href="{{ tagUrl }}" class="post-tag">{{ tag }}</a></li>
    {%- endfor %}
  </ul>

  {{ content | safe }}

  {%- if collections.posts %}
  {%- set previousPost = collections.posts | getPreviousCollectionItem %}
  {%- set nextPost = collections.posts | getNextCollectionItem %}
  {%- if nextPost or previousPost %}
  <nav aria-label="Post navigation">
    <ul class="links-nextprev">
      {%- if previousPost %}
      <li class="links-nextprev-prev">
        ← Previous<br>
        <a href="{{ previousPost.url }}">{{ previousPost.data.title }}</a>
      </li>
      {% endif %}
      {%- if nextPost %}
      <li class="links-nextprev-next">
        Next →<br>
        <a href="{{ nextPost.url }}">{{ nextPost.data.title }}</a>
      </li>
      {% endif %}
    </ul>
  </nav>
  {%- endif %}
  {%- endif %}
</article>

{# Interactive Highlighting Script #}
<script>
console.log('Highlight script loaded');

// Reading Progress Bar
const progressBar = document.getElementById('reading-progress');

function updateProgress() {
  const windowHeight = window.innerHeight;
  const documentHeight = document.documentElement.scrollHeight - windowHeight;
  const scrolled = window.scrollY;
  const progress = (scrolled / documentHeight) * 100;
  
  if (progressBar) {
    progressBar.style.width = Math.min(progress, 100) + '%';
  }
}

window.addEventListener('scroll', updateProgress);
window.addEventListener('resize', updateProgress);
updateProgress();

// Wait for page to fully load
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM loaded, setting up highlights');
  
  const article = document.querySelector('.post-content');
  
  if (!article) {
    console.error('No article element found');
    return;
  }
  
  console.log('Article found, adding listener');
  
  // Listen for text selection
  document.addEventListener('mouseup', function(e) {
    // Wait a tiny bit for selection to complete
    setTimeout(function() {
      const selection = window.getSelection();
      const text = selection.toString().trim();
      
      console.log('Selection:', text);
      
      if (text.length === 0 || text.length > 300) {
        return;
      }
      
      try {
        const range = selection.getRangeAt(0);
        
        // Check if selection is in the article
        let node = range.commonAncestorContainer;
        let inArticle = false;
        
        while (node) {
          if (node === article) {
            inArticle = true;
            break;
          }
          node = node.parentNode;
        }
        
        if (!inArticle) {
          console.log('Selection not in article');
          return;
        }
        
        // Create highlight
        const mark = document.createElement('mark');
        mark.className = 'user-highlight';
        mark.title = 'Click to remove';
        
        range.surroundContents(mark);
        
        console.log('Highlighted!');
        
        // Add remove handler
        mark.onclick = function(evt) {
          evt.stopPropagation();
          console.log('Removing highlight');
          const parent = this.parentNode;
          while (this.firstChild) {
            parent.insertBefore(this.firstChild, this);
          }
          parent.removeChild(this);
          parent.normalize();
        };
        
        selection.removeAllRanges();
        
      } catch (err) {
        console.error('Highlight error:', err);
      }
    }, 10);
  });
});
</script>