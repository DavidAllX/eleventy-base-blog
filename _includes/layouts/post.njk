---
layout: layouts/base.njk
---
{# Syntax highlighter CSS #}
<style>{% include "node_modules/prismjs/themes/prism-okaidia.css" %}</style>
<style>{% include "css/prism-diff.css" %}</style>

{# Reading progress bar #}
<div class="reading-progress" id="reading-progress"></div>

<article class="post-content">
  <h1>{{ title }}</h1>
  
  <ul class="post-metadata">
    <li><time datetime="{{ page.date | htmlDateString }}">{{ page.date | readableDate }}</time></li>
    {%- for tag in tags | filterTagList %}
    {%- set tagUrl %}/tags/{{ tag | slugify }}/{% endset %}
    <li><a href="{{ tagUrl }}" class="post-tag">{{ tag }}</a></li>
    {%- endfor %}
  </ul>

  {{ content | safe }}

  {%- if collections.posts %}
  {%- set previousPost = collections.posts | getPreviousCollectionItem %}
  {%- set nextPost = collections.posts | getNextCollectionItem %}
  {%- if nextPost or previousPost %}
  <nav aria-label="Post navigation">
    <ul class="links-nextprev">
      {%- if previousPost %}
      <li class="links-nextprev-prev">
        ← Previous<br>
        <a href="{{ previousPost.url }}">{{ previousPost.data.title }}</a>
      </li>
      {% endif %}
      {%- if nextPost %}
      <li class="links-nextprev-next">
        Next →<br>
        <a href="{{ nextPost.url }}">{{ nextPost.data.title }}</a>
      </li>
      {% endif %}
    </ul>
  </nav>
  {%- endif %}
  {%- endif %}
</article>

{# Interactive Highlighting Script - Enhanced with Persistence #}
<script>
console.log('Enhanced highlight script loaded');

// Reading Progress Bar
const progressBar = document.getElementById('reading-progress');

function updateProgress() {
  const windowHeight = window.innerHeight;
  const documentHeight = document.documentElement.scrollHeight - windowHeight;
  const scrolled = window.scrollY;
  const progress = (scrolled / documentHeight) * 100;
  
  if (progressBar) {
    progressBar.style.width = Math.min(progress, 100) + '%';
  }
}

window.addEventListener('scroll', updateProgress);
window.addEventListener('resize', updateProgress);
updateProgress();

// Enhanced Highlighting with Persistence
document.addEventListener('DOMContentLoaded', function() {
  const article = document.querySelector('.post-content');
  
  if (!article) {
    console.error('No article element found');
    return;
  }
  
  // Storage key unique to this blog post
  const storageKey = 'highlights_' + window.location.pathname;
  let highlights = [];
  
  // Load saved highlights
  try {
    const saved = localStorage.getItem(storageKey);
    if (saved) {
      highlights = JSON.parse(saved);
      console.log('Loaded', highlights.length, 'saved highlights');
      restoreHighlights();
    }
  } catch (e) {
    console.warn('Could not load highlights:', e);
  }
  
  // Listen for text selection
  document.addEventListener('mouseup', function(e) {
    setTimeout(function() {
      const selection = window.getSelection();
      const text = selection.toString().trim();
      
      if (text.length === 0 || text.length > 300) {
        return;
      }
      
      try {
        const range = selection.getRangeAt(0);
        
        // Check if selection is in the article
        let node = range.commonAncestorContainer;
        let inArticle = false;
        
        while (node) {
          if (node === article) {
            inArticle = true;
            break;
          }
          node = node.parentNode;
        }
        
        if (!inArticle) {
          return;
        }
        
        // Don't re-highlight already highlighted text
        const container = range.commonAncestorContainer.parentElement;
        if (container && container.classList.contains('user-highlight')) {
          return;
        }
        
        // Create highlight
        const mark = document.createElement('mark');
        mark.className = 'user-highlight';
        mark.title = 'Click to remove';
        mark.setAttribute('data-text', text);
        
        range.surroundContents(mark);
        
        // Save to storage
        if (!highlights.includes(text)) {
          highlights.push(text);
          saveHighlights();
          console.log('Saved highlight:', text.substring(0, 50) + '...');
        }
        
        // Add remove handler
        mark.onclick = function(evt) {
          evt.stopPropagation();
          removeHighlight(this);
        };
        
        selection.removeAllRanges();
        
      } catch (err) {
        console.error('Highlight error:', err);
      }
    }, 10);
  });
  
  function removeHighlight(element) {
    const text = element.getAttribute('data-text');
    const parent = element.parentNode;
    
    // Remove from storage
    highlights = highlights.filter(h => h !== text);
    saveHighlights();
    console.log('Removed highlight');
    
    // Remove visually
    while (element.firstChild) {
      parent.insertBefore(element.firstChild, element);
    }
    parent.removeChild(element);
    parent.normalize();
  }
  
  function saveHighlights() {
    try {
      localStorage.setItem(storageKey, JSON.stringify(highlights));
    } catch (e) {
      console.warn('Could not save highlights:', e);
    }
  }
  
  function restoreHighlights() {
    highlights.forEach(function(text) {
      // Find the text in the article
      const walker = document.createTreeWalker(
        article,
        NodeFilter.SHOW_TEXT,
        null,
        false
      );
      
      let node;
      while (node = walker.nextNode()) {
        const content = node.textContent;
        const index = content.indexOf(text);
        
        if (index !== -1) {
          try {
            const range = document.createRange();
            range.setStart(node, index);
            range.setEnd(node, index + text.length);
            
            const mark = document.createElement('mark');
            mark.className = 'user-highlight';
            mark.title = 'Click to remove';
            mark.setAttribute('data-text', text);
            
            range.surroundContents(mark);
            
            mark.onclick = function(evt) {
              evt.stopPropagation();
              removeHighlight(this);
            };
            
            break; // Only highlight first occurrence
          } catch (err) {
            console.warn('Could not restore highlight:', err);
          }
        }
      }
    });
  }
  
  // Smooth scroll for anchor links
  document.querySelectorAll('a[href^="#"]').forEach(function(anchor) {
    anchor.addEventListener('click', function(e) {
      const href = this.getAttribute('href');
      if (href === '#') return;
      
      e.preventDefault();
      const target = document.querySelector(href);
      if (target) {
        target.scrollIntoView({
          behavior: 'smooth',
          block: 'start'
        });
      }
    });
  });
});
</script>